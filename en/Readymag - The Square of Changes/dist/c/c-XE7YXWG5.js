import{g as V,h as z}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-U74ODL6G.js";import{a as q,d as M,e as ue}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-XQAFOQIN.js";import{a as N,b as T,e as de}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-4IKXPOHB.js";import{a as l}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-R4PAHBE6.js";import{a as j,b as pe}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-K45ZXRYF.js";import{c as A,d as I,k as le}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-U77NG7W3.js";import{a as me}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-RQ434LTH.js";import{l as f,m as ne,r as b,s as ce}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-42TSFLLH.js";import{a as ae}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-JTEJSVZP.js";import{e as L,g as R,h as oe}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-G4GX3XOZ.js";import{g as B,h as H,i as P,j as W,k as y,l as he}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-HKXDGYOU.js";import{g as _,h as te}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-VUD7OPNE.js";import{b as c,c as se}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-SXBIDYQQ.js";import{a as re}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-3SFTLRL3.js";import{b as ie}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-W2OJRSJR.js";import{d as S}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-TZYDFHR2.js";var p=S(ie()),a=S(re()),U=S(ae());he();te();var G=S(me());ce();ne();se();le();ue();de();pe();oe();var E=c.stripe_live?c.STRIPE_LIVE_PUBLIC_KEY:c.STRIPE_TEST_PUBLIC_KEY,K=async()=>{typeof window<"u"&&(k=(await import("https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-XEKJBHRN.js")).default)},k=async(...e)=>{await K(),k(...e)};K();var ge=U.default.View.extend({template:V["template-viewer-cart-sidebar"],cardStyle:{base:{letterSpacing:"0.3px",color:"#0080FF",fontSize:"16px",fontFamily:"-apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Ubuntu, 'Fira Sans', Roboto, 'Avenir Next', 'Helvetica Neue', Helvetica, Arial, sans-serif","::placeholder":{color:"#CFD7DF"},fontSmoothing:"antialiased"},invalid:{color:"#e5424d",":focus":{color:"#303238"}}},initialize:function(e){return p.default.bindAll(this),this.mag=e,this.environment=this.mag.router.environment,this.rendered=!1,this.haveSkus=!1,this.havePrices=!1,this.checkoutComplete=!1,this.isHiddenSettings=!0,this.activeTab="tab-items",this.orderLoading=!1,this.paymentLoading=!1,this.hoveredItem=null,this.shippingForm={name:{value:null,error:null,validationRules:[{title:"required"}]},phone:{value:null,error:null,validationRules:[{title:"phoneNumber"}]},line1:{value:null,error:null,validationRules:[{title:"required"}]},line2:{value:null,error:null,validationRules:[]},city:{value:null,error:null,validationRules:[{title:"required"}]},state:{value:null,error:null,validationRules:[]},country:{value:"default",error:null,validationRules:[{title:"required",func:(t,i)=>i==="default"?"field is required":null}]},postal_code:{value:null,error:null,validationRules:[]},email:{value:null,error:null,validationRules:[{title:"required"},{title:"email"}]},note:{value:null,error:null,validationRules:[]}},this.cardHolderNameValue=null,this.clearShippingFormField_debounced=p.default.debounce(this.clearShippingFormField,200),this.render(),this},render:function(){if(RM.screenshot)return;{let t=j.getPermissions();if(!t||!t.can_use_e_commerce)return}if(!this.mag.eCommerceManager.isCartWidgetExist||this.mag.eCommerceManager.isPublished&&this.mag.eCommerceManager.getConnectedProvider()!=="stripe"||this.rendered)return;this.rendered=!0,document.querySelectorAll("#cart-sidebar").length&&document.querySelectorAll("#cart-sidebar").forEach(t=>t.parentNode.removeChild(t)),this.setElement(this.template({isMobile:(0,G.isMobile)(),isViewer:this.environment===c.environment.viewer,imgPublicPath:N})),this.$el.appendTo((0,a.default)("body")),this.$toolbar=(0,a.default)(".toolbar.for-viewer"),this.$tabs=this.$el.find(".cart-sidebar-tabs"),this.$items=this.$el.find(".cart-items-list"),this.$closeButton=this.$el.find(".close-button"),this.$footer=this.$el.find(".sidebar-footer"),this.$navButtons=this.$el.find(".sidebar-btn"),this.$calcTextContainer=this.$el.find(".text-size-calc-container"),this.$successPaymentInMainTab=this.$el.find(".payment-success-main-tab"),this.$itemsTab=this.$tabs.find(".tab-items"),this.$shippingTab=this.$tabs.find(".tab-inputs"),this.$orderTab=this.$tabs.find(".tab-order"),this.$paymentTab=this.$tabs.find(".tab-checkout"),this.$goToPayment=this.$orderTab.find(".cart-pay-btn"),this.$orderDetails=this.$orderTab.find(".order-details"),this.$orderItems=this.$orderTab.find(".order-items-list"),this.$orderError=this.$orderTab.find(".order-error"),this.$orderShippingAddress=this.$orderTab.find(".order-shipping-address"),this.$orderShippingMethod=this.$orderTab.find(".order-shipping-method"),this.$orderShippingEmail=this.$orderTab.find(".order-shipping-email"),this.$orderTax=this.$orderTab.find(".order-tax"),this.$orderTotalPrice=this.$orderTab.find(".order-total-price"),this.$paymentSuccess=this.$tabs.find("#payment-success-msg"),this.$paymentFailed=this.$tabs.find("#payment-failed-msg"),this.cartWidgetData=A(this.environment,[...this.mag.staticGlobalWidgetsData,...this.mag.aboveGlobalWidgetsData]),this.environment===c.environment.preview&&(this.cartWidgetData&&this.cartWidgetData._id&&this.setupSettingsPanel(),window.RM.constructorRouter.on("previewClose",this.closeSideBar.bind(this)),this.bindTextInputsEvents());let e=this.$el.find(".svg");return k(e),this.$el.find("[data-alt]:not(.rmalttext)").RMAltText(),this.generateSidebarCSS(this.cartWidgetData),this.renderSidebarTexts(),this.renderCartItems(),this.renderShippingForm(),this.initNavigation(),this.bindDomEvents(),f.on("ecommerce:cartsidebar:visibility:changed",this.toggleSidebar),f.on("ecommerce:cartdata:changed",this.renderCartItems),this.mag.eCommerceCartManager.openSidebarOnRender&&(f.once("ecommerce:billingPortalUrl:get",this.onGetBillingPortalUrl),typeof this.mag.eCommerceCartManager.openSidebarOnRender=="object"&&p.default.extend(this,this.mag.eCommerceCartManager.openSidebarOnRender),this.mag.eCommerceCartManager.openCartSidebar(),this.mag.eCommerceCartManager.openSidebarOnRender=!1),this},bindDomEvents:function(){this.$closeButton.on("click",this.closeSideBar.bind(this)),this.$tabs.find(".cart-cancel-btn").on("click",this.cancelOrder.bind(this)),(0,a.default)(document).on("mouseover",".cart-sidebar .sidebar-body .cart-item-block",this.cartItemBlockHover),(0,a.default)(document).on("mouseleave",".cart-sidebar .sidebar-body .cart-item-block",this.cartItemBlockLeave),this.bindStaticTextFieldsHovers()},unbindDomEvents:function(){this.$closeButton.off("click",this.closeSideBar),this.$tabs.find(".cart-cancel-btn").off("click",this.cancelOrder),(0,a.default)(document).off("mouseover",".cart-sidebar .sidebar-body .cart-item-block",this.cartItemBlockHover),(0,a.default)(document).off("mouseleave",".cart-sidebar .sidebar-body .cart-item-block",this.cartItemBlockLeave)},bindStaticTextFieldsHovers:function(){this.environment===c.environment.preview&&(this.$itemsTab.find(".cart-title-input, .empty-cart-title-input").on("mouseover",e=>{(0,a.default)(e.target).addClass("active")}),this.$itemsTab.find(".cart-title-input, .empty-cart-title-input").on("mouseleave",e=>{(0,a.default)(e.target).is(":focus")||(0,a.default)(e.target).removeClass("active")}),this.$itemsTab.find(".\u0441heck-out-btn").on("mouseover",e=>{(0,a.default)(e.target).find(".cart-checkout-input").addClass("active")}),this.$itemsTab.find(".\u0441heck-out-btn").on("mouseleave",e=>{let t=(0,a.default)(e.target).find(".cart-checkout-input");t.is(":focus")||t.removeClass("active")}))},hideSidebar:function(){this.$el.removeClass("show"),(0,a.default)("body").removeClass("cart-sidebar-shown"),(0,a.default)("html").removeClass("cart-disable-scroll"),!this.isHiddenSettings&&this.settingsPanel&&(this.isHiddenSettings=!0,this.settingsPanel.isHidden=this.isHiddenSettings)},toggleSidebar:function(e){if(e)this.hideSidebar(),this.checkoutComplete&&(this.checkoutComplete=!1,this.mag.eCommerceCartManager.clearCart(),this.goToInitialTab(),this.hideSuccessPaymentMessage(),this.$paymentFailed.empty(),!this.$successPaymentInMainTab.hasClass("hidden")&&this.$successPaymentInMainTab.addClass("hidden"),this.$successPaymentInMainTab.find(".billing-portal-url").empty()),this.clearOrderError();else{this.$el.addClass("show"),(0,a.default)("body").addClass("cart-sidebar-shown"),(0,a.default)("html").addClass("cart-disable-scroll"),this.checkoutComplete&&(this.$itemsTab.find(".empty-cart").css("display","none"),this.$successPaymentInMainTab.removeClass("hidden"));try{let t=this.mag.eCommerceCartManager.getCartData(),{value:i,currency:r,items:s}=M(Object.values(t.prices));RM.analytics&&RM.analytics.sendEvent("view_cart",{ecommerceData:{value:i,currency:r,items:s}})}catch(t){console.error("Cannot send GA analytics: ",t)}}},closeSideBar:function(){this.mag.eCommerceCartManager.isCartSidebarHidden||this.mag.eCommerceCartManager.changeCartSidebarVisibility()},onGetBillingPortalUrl:function(e){e&&this.$successPaymentInMainTab.find(".billing-portal-url").append(`<a href="${e}">Manage your subscription</a>`)},initNavigation:function(){this.$tabs.find("[data-tab^='tab-']").each(function(e,t){(0,a.default)(t).on("click",function(i){if(!i.isDefaultPrevented()){if(this.haveSkus&&this.havePrices){window.alert("You can't buy all these products, try separately");return}(this.haveSkus||this.havePrices)&&(this.customNavigationActions(t,i)||this.goToTabByClassname("."+t.dataset.tab))}}.bind(this))}.bind(this))},customNavigationActions:function(e){if(e.dataset.tab==="tab-inputs"){if(this.havePrices)return this.goToStripeCheckout(),!0;this.updateShippingForm(),RM.analytics&&RM.analytics.sendEvent("Checkout 1st step completed")}if(e.dataset.tab==="tab-order")if(this.validateShippingForm()){this.clearShippingFormErrors(),RM.analytics&&RM.analytics.sendEvent("Checkout 2nd step completed");let t=this.mag.eCommerceCartManager.getShippingForm(),i,r;t&&(i=p.default.mapObject(t,s=>({value:s.value})),r=p.default.mapObject(this.shippingForm,s=>({value:s.value}))),(!t||t&&!p.default.isEqual(i,r))&&(this.mag.eCommerceCartManager.setShippingForm(this.shippingForm),this.havePrices&&(this.needForUpdateCustomer=!0)),this.haveSkus&&this.renderOrderTab(),this.havePrices&&this.renderOrderTabForPrices()}else return this.renderShippingFormErrors(),!0;e.dataset.tab==="tab-checkout"&&(RM.analytics&&RM.analytics.sendEvent("Checkout 3rd step completed"),this.haveSkus&&this.renderCheckoutForm(),this.havePrices&&this.renderCheckoutFormPaymentIntent())},goToTabByClassname:function(e){this.$tabs.find(".cart-sidebar-tab").each(function(t,i){(0,a.default)(i).removeClass("active")}),this.$tabs.find(e).addClass("active"),this.activeTab=e.slice(1)},goToInitialTab(){this.goToTabByClassname(".tab-items")},generateSidebarCSS(e){let t=`cart_sidebar_styles_${e._id}`,i=b.getRGBA(e["bar-color"],e["bar-color-opacity"]/100),r=b.getRGBA(e["bar-background-color"],e["bar-background-color-opacity"]/100),s=b.getRGBA(e["bar-color"],e["bar-color-opacity"]*.45/100),n=b.getRGBA(e["bar-color"],e["bar-color-opacity"]*.9/100),o=16*(e["bar-font-size-factor"]||1),d=this.getAdditionalColor(r);this.cardStyle={...this.cardStyle,base:{...this.cardStyle.base,color:i,fontSize:`${o}px`,fontWeight:e["bar-font-weight"],"::placeholder":{color:s}},invalid:{...this.cardStyle.invalid,color:s,fontWeight:e["bar-font-weight"],":focus":{color:i},"::placeholder":{color:s}}};let u=`    #cart-sidebar {
      color: ${i};
      background-color: ${r};
      box-shadow: ${e["bar-shadow"]?"0 0 4px rgba(124, 124, 125, 0.5)":"none"};
      font-size: ${o}px !important;
      font-family: ${e["bar-font-family"]};
      font-weight: ${e["bar-font-weight"]};
      font-style: ${e["bar-font-style"]};
    }

    #cart-sidebar textarea {
      font-family: ${e["bar-font-family"]};
      font-weight: ${e["bar-font-weight"]};
      font-style: ${e["bar-font-style"]};
    }

    #cart-sidebar input, #cart-sidebar .\u0441heck-out-btn {
      color: ${i};
      font-family: ${e["bar-font-family"]};
      font-weight: ${e["bar-font-weight"]};
      font-style: ${e["bar-font-style"]};
    }

    #cart-sidebar input::placeholder {
      color: ${s};
    }

    #cart-sidebar .cart-title-input.active {
      border-color: ${y(.8,i)};
    }

    #cart-sidebar .empty-cart-title-input.active {
      border-color: ${y(.8,i)};
    }

    #cart-sidebar .payment-success-main-tab a {
      color: ${i};
      font-family: ${e["bar-font-family"]};
      font-weight: ${e["bar-font-weight"]};
      font-style: ${e["bar-font-style"]};
    }

    #cart-sidebar .cart-price-input.active, #cart-sidebar .cart-quantity-input.active {
      border-color: ${y(.2,s)};
    }

    #cart-sidebar .cart-checkout-input.active {
      border-color: ${y(.8,i)};
    }

    #cart-sidebar .cart-price-input {
      color: ${n};
      font-family: ${e["bar-font-family"]};
      font-weight: ${e["bar-font-weight"]};
      font-style: ${e["bar-font-style"]};
    }

    #cart-sidebar .cart-quantity-input {
      color: ${n};
      font-family: ${e["bar-font-family"]};
      font-weight: ${e["bar-font-weight"]};
      font-style: ${e["bar-font-style"]};
    }

    #cart-sidebar button {
      font-family: ${e["bar-font-family"]};
      font-weight: ${e["bar-font-weight"]};
      font-style: ${e["bar-font-style"]};
    }

    #cart-sidebar .sidebar-btn > input, #cart-sidebar .sidebar-btn > span {
      top: ${e["bar-button-baseline"]+"px"||0};
    }

    #cart-sidebar select {
      font-family: ${e["bar-font-family"]};
      font-weight: ${e["bar-font-weight"]};
      font-style: ${e["bar-font-style"]};
    }

    #cart-sidebar .sidebar-btn {
      color: ${i};
      border-color: ${s};
    }

    #cart-sidebar .sidebar-btn path {
      fill: ${i};
    }

    #cart-sidebar .sidebar-icon-btn path, #cart-sidebar .sidebar-icon-btn rect {
      fill: ${i};
    }

    #cart-sidebar .preloader svg path {
      stroke: ${i};
    }

    #cart-sidebar .expand-arrow svg path {
      fill: ${i};
    }

    #cart-sidebar .cart-cancel-btn {
      color: ${i};
    }

    #cart-sidebar .sidebar-body .cart-item-block.hover {
      background-color: ${d};
    }

    #cart-sidebar .sidebar-body .cart-item-block .cart-item-attributes {
      color: ${n};
    }

    #cart-sidebar .sidebar-body .cart-item-block .cart-item-price {
      color: ${n};
    }

    #cart-sidebar .sidebar-body .cart-item-block .cart-items-quantity {
      color: ${n};
    }

    #cart-sidebar .sidebar-body .cart-item-block .cart-item-remove-btn-icon path {
      fill: ${i};
    }

    #cart-sidebar .sidebar-body .cart-item-block .cart-item-decrease-btn-icon rect {
      fill: ${i};
    }

    #cart-sidebar .sidebar-body .cart-item-block .cart-item-increase-btn-icon path {
      fill: ${i};
    }

    #cart-sidebar .sidebar-body .order-details-form, #cart-sidebar .sidebar-body .order-details-form .form-input {
      color: ${i};
    }

    #cart-sidebar .sidebar-body .order-details-form .form-input::placeholder {
      color: ${s};
    }

    #cart-sidebar .sidebar-body .order-details-form .rm-native-fake-select {
      color: ${s};
    }

    #cart-sidebar .sidebar-body .order-details-form .rm-native-fake-select.selected {
      color: ${i};
    }

    #cart-sidebar .sidebar-body .order-details-form svg path {
      fill: ${i};
    }

    #cart-sidebar .sidebar-body .order-details-form .form-title {
      color: ${i};
    }

    #cart-sidebar .sidebar-body .form-error {
      background-color: ${i};
    }

    #cart-sidebar .sidebar-body .order-details-form .rm-native-select-popup {
      background-color: ${d};
    }

    #cart-sidebar .tab-order .order-details .order-title-row {
      color: ${s};
    }

    #cart-sidebar .tab-order .order-details .rm-native-fake-select {
      color: ${i};
    }

    #cart-sidebar .tab-checkout .payment-input {
      color: ${i};
    }

    #cart-sidebar .tab-checkout .payment-input::placeholder {
      color: ${s};
    }

    #cart-sidebar .tab-checkout #payment-failed-msg .error-icon {
      border-color: ${s};
    }

    #cart-sidebar .tab-checkout #payment-failed-msg .error-icon svg g {
      fill: ${i};
    }

    #cart-sidebar .sidebar-settings-container .settings-button path {
      stroke: ${i};
    }

    #cart-sidebar .sidebar-settings-container .settings-button:hover path {
      stroke: ${s};
    }

    #cart-sidebar .sidebar-settings-container .settings-toggle {
      color: ${i};
    }

    #cart-sidebar .sidebar-settings-container .settings-toggle:hover {
      color: ${s};
    }

    #cart-sidebar.cart-is-mobile .sidebar-body .cart-item-block {
      background-color: ${d};
    }`;(0,a.default)(`#${t}`).remove();let m=document.createElement("style");m.type="text/css",m.id=t,m.className="cart-sidebar-styles",m.appendChild(document.createTextNode(u)),document.querySelector("head").appendChild(m)},getAdditionalColor(e){return H(e)<.05&&P("#fff",e)-P("#000",e)>=8?W(.1,e):B(.1,e)},renderCartItems:function(){let e=this.mag.eCommerceCartManager.getCartData();if(!e||!e.skus)return;let t=Object.keys(e.skus),i=Object.keys(e.prices);this.$items.empty(),this.haveSkus=!!t.length,this.havePrices=!!i.length,!this.checkoutComplete&&!this.$successPaymentInMainTab.hasClass("hidden")&&this.$successPaymentInMainTab.addClass("hidden"),this.haveSkus||this.havePrices?(this.$itemsTab.find(".\u0441heck-out-btn").css("display","flex"),!this.checkoutComplete&&this.$itemsTab.find(".empty-cart").css("display","none"),this.environment===c.environment.viewer&&this.$itemsTab.find(".sidebar-title").css("display","flex")):(this.$itemsTab.find(".\u0441heck-out-btn").css("display","none"),!this.checkoutComplete&&this.$itemsTab.find(".empty-cart").css("display","flex"),this.environment===c.environment.viewer&&this.$itemsTab.find(".sidebar-title").css("display","none")),this.renderPricesCartItems(i),this.renderSkusCartItems(t);let r=this.$items.find(".svg");k(r),this.renderSidebarTexts(),this.unbindTextInputsEvents(!0),this.bindTextInputsEvents(!0)},renderCartItem(e,t="price"){let i=this.hoveredItem===e.id,r=(0,a.default)("<div/>",{class:`cart-item-block${i?" hover":""}`});r.data(`${t}-id`,e.id);let s;if(e.image||e.productObject.images&&e.productObject.images.length){let h=e.image?e.image:e.productObject.images?e.productObject.images[0]:"";s=(0,a.default)("<div/>",{class:"cart-item-image",css:{"background-position":"center center","background-size":"cover","background-repeat":"no-repeat","background-image":`url(${h})`}}),r.append(s)}let o=(0,a.default)("<div/>",{class:s?"cart-item-title":"cart-item-title without-image"}).text(e.productObject.name),d=e.cart_count,u=((t==="price"?e.unit_amount:e.price)/100).toFixed(2),m=l(u,e.currency),Y=l((u*d).toFixed(2),e.currency),F=(0,a.default)("<div/>",{class:"cart-item-price"}),D=(0,a.default)("<input/>",{type:"text",class:"cart-text-input cart-price-input",name:"price",placeholder:"Price",maxlength:"32",translate:"no",autocomplete:"no",autocorrect:"no",spellcheck:"false"});D.get(0).dataset.dynamicWidth=!0;let Q=(0,a.default)('<span class="cart-item-price-value"/>').html(d>1?`: ${m} \xD7 ${d} = ${Y}`:`: ${m}`);F.append(D).append(Q);let x;if(t==="sku"){x=(0,a.default)("<div/>",{class:"cart-item-attributes"});let h=e.attributes;for(let $ in h){let ee=(0,a.default)("<div/>",{class:"cart-item-attribute"}).html(`${b.capitalize($)}: ${h[$]}`);x.append(ee)}}let w=(0,a.default)("<div/>",{class:"cart-items-quantity"}),O=(0,a.default)("<input/>",{type:"text",class:"cart-text-input cart-quantity-input",name:"quantity",placeholder:"Quantity",maxlength:"32",translate:"no",autocomplete:"no",autocorrect:"no",spellcheck:"false"});O.get(0).dataset.dynamicWidth=!0;let J=(0,a.default)('<span class="cart-item-quantity-value"/>').html(`: ${d}`);w.append(O).append(J);let C=(0,a.default)("<div/>",{class:"cart-item-remove-btn",title:"remove"}).attr(`data-${t}-id`,e.id),X=(0,a.default)("<img/>",{class:"svg cart-item-remove-btn-icon sidebar-icon-btn",src:T("./viewer/cart-sidebar/cart-item-delete.svg?c")});C.append(X),C.on("click",this.onRemoveItem);let v=(0,a.default)("<div/>",{class:"cart-item-edit-group"}),g=(0,a.default)("<div/>",{class:"cart-item-increase-btn"}).attr(`data-${t}-id`,e.id),Z=(0,a.default)("<img/>",{class:"svg cart-item-increase-btn-icon sidebar-icon-btn",src:T("./viewer/cart-sidebar/cart-item-increase.svg?c")});if(g.append(Z),v.append(g),t==="price"?(g.addClass("active"),g.on("click",this.onIncreaseItem)):this.mag.eCommerceCartManager.checkItemQuantity(e.id)&&(g.addClass("active"),g.on("click",this.onIncreaseItem)),d>1){let h=(0,a.default)("<div/>",{class:`cart-item-decrease-btn decrease-btn-${e.id}`}).attr(`data-${t}-id`,e.id),$=(0,a.default)("<img/>",{class:"svg cart-item-decrease-btn-icon sidebar-icon-btn",src:T("./viewer/cart-sidebar/cart-item-decrease.svg?c")});h.append($),v.append(h),h.on("click",this.onDecreaseItem)}else{let h=this.$items.find(`decrease-btn-${e.id}`);h.off("click",this.onDecreaseItem),h.remove()}t==="price"?r.append(o).append(F).append(w).append(C).append(v):r.append(o).append(x).append(F).append(w).append(C).append(v),this.$items.append(r)},renderPricesCartItems(e){let t=this.mag.eCommerceCartManager.getCartData();e.forEach(i=>{let r=t.prices[i];r.active&&this.renderCartItem(r)})},renderSkusCartItems(e){let t=this.mag.eCommerceCartManager.getCartData();e.forEach(i=>{let r=t.skus[i];r.active&&this.renderCartItem(r,"sku")})},onRemoveItem:function(e){let t;e.currentTarget.dataset.priceId?t=this.mag.eCommerceCartManager.removeFromCart(e.currentTarget.dataset.priceId):e.currentTarget.dataset.skuId&&(t=this.mag.eCommerceCartManager.removeSkuFromCart(e.currentTarget.dataset.skuId));let{value:i,currency:r,items:s}=M(Object.values([t]));RM.analytics&&RM.analytics.sendEvent("remove_from_cart",{ecommerceData:{value:i,currency:r,items:s}})},onIncreaseItem:function(e){e.currentTarget.dataset.priceId?this.mag.eCommerceCartManager.increaseCartItem(e.currentTarget.dataset.priceId):e.currentTarget.dataset.skuId&&this.mag.eCommerceCartManager.increaseSkuCartItem(e.currentTarget.dataset.skuId)},onDecreaseItem:function(e){e.currentTarget.dataset.priceId?this.mag.eCommerceCartManager.decreaseCartItem(e.currentTarget.dataset.priceId):e.currentTarget.dataset.skuId&&this.mag.eCommerceCartManager.decreaseSkuCartItem(e.currentTarget.dataset.skuId)},getTextFieldModelKey(e){return`bar-${e}`},getSidebarTextValue(e){let t=this.getTextFieldModelKey(e);return this.cartWidgetData&&this.cartWidgetData[t]?_.sanitize(this.cartWidgetData[t]):c.defaultSidebarTexts[e]?c.defaultSidebarTexts[e]:null},calcTextFieldSize(e){if(!e)return null;let t=getComputedStyle(e);this.$calcTextContainer.css({"font-family":t.fontFamily,"font-size":t.fontSize,"font-style":t.fontStyle,"font-weight":t.fontWeight,"letter-spacing":t.letterSpacing}),this.$calcTextContainer.text(e.value);let i=this.$calcTextContainer.width();return Math.ceil(i)},renderSidebarTexts(){this.$itemsTab.find(".cart-text-input").each((e,t)=>{let i=t.getAttribute("name"),r=this.getSidebarTextValue(i);if(r&&(t.value=r,t.dataset.dynamicWidth)){let s=this.calcTextFieldSize(t);s&&(t.style.width=`${s}px`)}})},bindTextInputsEvents(e=!1){this.$itemsTab.find(".cart-text-input"+(e?'[data-dynamic-width="true"]':"")).each((t,i)=>{(0,a.default)(i).on("click",this.onTextFieldClick),(0,a.default)(i).on("input",this.onTextFieldChange),(0,a.default)(i).on("focus",this.onTextFieldFocus),(0,a.default)(i).on("blur",this.onTextFieldBlur)}),e&&this.environment===c.environment.preview&&(this.$itemsTab.find(".cart-item-block").on("mouseover",this.onDynamicMouseOver),this.$itemsTab.find(".cart-item-block").on("mouseleave",this.onDynamicMouseLeave))},unbindTextInputsEvents(e=!1){this.$itemsTab.find(".cart-text-input"+(e?'[data-dynamic-width="true"]':"")).each((t,i)=>{(0,a.default)(i).off("click",this.onTextFieldClick),(0,a.default)(i).off("input",this.onTextFieldChange),(0,a.default)(i).off("focus",this.onTextFieldFocus),(0,a.default)(i).off("blur",this.onTextFieldBlur)}),e&&this.environment===c.environment.preview&&(this.$itemsTab.find(".cart-item-block").off("mouseover",this.onDynamicMouseOver),this.$itemsTab.find(".cart-item-block").off("mouseleave",this.onDynamicMouseLeave))},onDynamicMouseOver(e){(0,a.default)(e.target).find(".cart-price-input, .cart-quantity-input").addClass("active")},onDynamicMouseLeave(e){(0,a.default)(e.target).find(".cart-price-input, .cart-quantity-input").each(function(){(0,a.default)(this).is(":focus")||(0,a.default)(this).removeClass("active")})},onTextFieldClick(e){e.preventDefault()},onTextFieldChange(e){if(e.target.dataset.dynamicWidth){let t=this.calcTextFieldSize(e.target);t&&(e.target.style.width=`${t}px`)}},onTextFieldFocus(e){this.environment===c.environment.preview&&(0,a.default)(e.target).addClass("active")},onTextFieldBlur(e){this.environment===c.environment.preview&&(0,a.default)(e.target).removeClass("active");let t=e.target.getAttribute("name"),i=this.getSidebarTextValue(t);if(i){if(!e.target.value){e.target.value=i;return}if(this.cartWidgetModel){let s={[this.getTextFieldModelKey(t)]:e.target.value};this.updateCartWidgetData(s),this.cartWidgetModel.save(s,{toHistory:!1,skipHistory:!0,patch:!0}).then(()=>{e.target.dataset.dynamicWidth&&this.renderSidebarTexts()})}}},async goToStripeCheckout(){let e=I(this.mag.eCommerceManager.ecommerceData);this.stripe||(this.stripe=Stripe(E,{stripeAccount:e}));let t={showPromoCodes:!!this.cartWidgetData["stripe-allow_promotion_codes"]};this.cartWidgetData["stripe-shipping_rates"]?.length&&this.cartWidgetData["stripe-allowed_countries"]?.length&&(t.shippingRates=this.cartWidgetData["stripe-shipping_rates"],t.shippingAddressCollection={allowed_countries:this.cartWidgetData["stripe-allowed_countries"].map(i=>i.value)}),this.mag.eCommerceCartManager.createCheckoutSession(t).then(({data:i})=>{this.stripe.redirectToCheckout({sessionId:i.id})}).catch(i=>{console.error("Error:",i)});try{let i=this.mag.eCommerceCartManager.getCartData(),{value:r,currency:s,items:n}=M(Object.values(i.prices));RM.analytics&&RM.analytics.sendEvent("begin_checkout",{ecommerceData:{value:r,currency:s,items:n}})}catch(i){console.error("Cannot send GA analytics: ",i)}},renderShippingForm:async function(){let e=p.default.clone(z);e.unshift({value:"default",caption:"Country"});let i=this.mag.eCommerceCartManager.getCartData().shippingForm;i&&typeof i=="object"&&(this.shippingForm=i);let{default:r}=await import("https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-M4272OMK.js"),{default:s}=await import("https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-GXPKNDBF.js"),n=s.extend(r);this.countrySelect=new n({el:this.$tabs.find(".countries-select").get(0),propsData:{options:()=>e,value:this.shippingForm.country.value,isDesktop:!1,callback:this.onCountryChange}}),this.mag.eCommerceCartManager.hasShippableProducts()?this.$shippingTab.find(".shipping-form").removeClass("hidden"):this.$shippingTab.find(".shipping-form").addClass("hidden"),this.$tabs.find(".order-details-form .form-input").each((o,d)=>{let u=d.getAttribute("name");this.shippingForm[u]&&(d.value=this.shippingForm[u].value),(0,a.default)(d).on("input",this.onShippingFormChange)})},updateShippingForm(){let e=this.mag.eCommerceCartManager.getShippingForm();e&&typeof e=="object"&&(this.shippingForm=e),this.mag.eCommerceCartManager.hasShippableProducts()?this.$shippingTab.find(".shipping-form").removeClass("hidden"):this.$shippingTab.find(".shipping-form").addClass("hidden")},onCountryChange(e){this.shippingForm.country.value=e,this.countrySelect.value=e,this.clearShippingFormField_debounced("country")},onShippingFormChange(e){let t=e.target.getAttribute("name");this.shippingForm[t]!==void 0&&typeof this.shippingForm[t]=="object"&&(this.shippingForm[t].value=e.target.value,this.clearShippingFormField_debounced(t))},renderShippingFormErrors(){Object.keys(this.shippingForm).forEach(e=>{this.shippingForm[e].error&&this.$shippingTab.find(`.form-error.${e}-error`).removeClass("hidden")})},clearShippingFormErrors(){Object.keys(this.shippingForm).forEach(e=>{this.$tabs.find(`.form-error.${e}-error`).addClass("hidden")})},clearShippingFormField(e){if(this.shippingForm[e]!==void 0&&this.shippingForm[e].error){let t=this.validateShippingFormField(e);t&&t.success&&(this.$tabs.find(`.form-error.${e}-error`).addClass("hidden"),this.shippingForm[e].error=null)}},validateShippingFormField(e){let t=[];if(this.shippingForm[e]!==void 0){if(this.shippingForm[e].validationRules.length)this.shippingForm[e].validationRules.forEach(i=>{if(typeof i.func=="function"){let r=i.func(e,this.shippingForm[e].value);r&&t.push(r)}else{let r=this[`${i.title}Validation`](e,this.shippingForm[e].value);r&&t.push(r)}});else return{success:!0};return t.length?{success:!1,error:!0,errorMessages:t}:{success:!0}}},requiredValidation(e,t){return t?null:"field is required"},emailValidation(e,t){return t?L(t)?null:"it's not email":null},phoneNumberValidation(e,t){return t?R(t)?null:"it's not  phone number":null},validateShippingForm(){let e=!1;if(this.mag.eCommerceCartManager.hasShippableProducts())for(let t in this.shippingForm){let i=this.validateShippingFormField(t);i&&(i.success?this.shippingForm[t].error=null:(this.shippingForm[t].error=i.errorMessages,e=!0))}else{let t=this.validateShippingFormField("email");t&&(t.success?this.shippingForm.email.error=null:(this.shippingForm.email.error=t.errorMessages,e=!0))}return!e},renderOrderTab:function(){this.clearOrderError();let e=this.mag.eCommerceCartManager.getCartData(),t=e.order;if(t&&t.created<Math.floor(Date.parse(e.changed)/1e3)){this.showOrderLoader(),this.mag.eCommerceCartManager.cancelOrder().then(i=>{i.data&&i.data.status==="canceled"&&(this.mag.eCommerceCartManager.deleteOrder(),this.createOrder())}).catch(i=>{this.hideOrderLoader(),this.renderOrderError(i&&i.message?i.message:""),this.mag.eCommerceCartManager.deleteOrder()});return}else if(t){this.renderOrderDetails();return}this.createOrder()},renderOrderTabForPrices:async function(){this.clearOrderError(),this.showOrderLoader();let e=await this.getCustomer();if(e&&await this.getInvoiceItemsForCustomer(e.id)){let i=await this.getInvoiceForCustomer(e.id);if(i)if(i.created<Math.floor(Date.parse(this.mag.eCommerceCartManager.getCartData().changed)/1e3)){this.needForUpdateCustomer&&(await this.updateOrCreateCustomer(),this.needForUpdateCustomer=!1);try{await this.cancelInvoice(i)}catch{this.renderOrderError("can't cancel old order"),this.hideOrderLoader();return}try{let r=await this.createInvoiceWithItems();r&&this.renderInvoiceDetails(r)}catch{this.renderOrderError("can't create order")}}else this.renderInvoiceDetails(i)}this.hideOrderLoader()},renderInvoiceDetails:async function(e){if(this.$orderItems.empty(),this.$orderShippingAddress.empty(),this.$orderShippingMethod.empty(),this.$orderShippingEmail.empty(),this.$orderTax.empty(),this.$orderTotalPrice.empty(),e.lines.data.forEach(t=>{let i=(0,a.default)("<div/>",{class:"order-item"}).html(t.quantity+" \xD7 "+t.description),r=(0,a.default)("<div/>",{class:"order-item-price"}).text(l((t.amount/100).toFixed(2),t.currency));i.append(r),this.$orderItems.append(i)}),e.customer_shipping&&e.customer_shipping.address){let t=s=>s?` ${s}`:"",i=e.customer_shipping.address,r=`${i.line1}${t(i.line2)} ${i.city},${t(i.state)}${t(i.postal_code)} ${i.country}`;this.$orderShippingAddress.text(r),this.$tabs.find(".shipping-details").removeClass("hidden")}this.$orderShippingMethod.parent(".shipping-method.order-row").addClass("hidden"),this.$orderDetails.find(".order-id").text(String(e.id).slice(0,20)+"..."),this.$orderShippingEmail.text(e.customer_email),this.$orderDetails.find(".shipping-email").removeClass("hidden"),e.customer_phone?(this.$orderDetails.find(".order-shipping-phone").text(e.customer_phone),this.$orderDetails.find(".shipping-phone").removeClass("hidden")):this.$orderDetails.find(".shipping-phone").addClass("hidden"),e.tax?(this.$orderTax.parent(".shipping-tax-size.order-row").removeClass("hidden"),this.$orderTax.text(l((e.tax/100).toFixed(2),e.currency))):this.$orderTax.parent(".shipping-tax-size.order-row").addClass("hidden"),this.$orderTotalPrice.text(l((e.total/100).toFixed(2),e.currency)),this.$goToPayment.removeClass("hidden")},getCustomer:async function(){let e=this.mag.eCommerceCartManager.getCartData();if(e.customer)return e.customer;try{let t=await this.mag.eCommerceCartManager.createOrUpdateCustomer(this.mag.num_id,this.generateCustomerDataFromShippingForm(e.shippingForm));if(t&&t.data)return this.mag.eCommerceCartManager.setCustomer(t.data),t.data}catch(t){throw console.error(t),t}},updateOrCreateCustomer:async function(){let e=this.mag.eCommerceCartManager.getCartData(),t=await this.mag.eCommerceCartManager.createOrUpdateCustomer(this.mag.num_id,this.generateCustomerDataFromShippingForm(e.shippingForm));if(t&&t.data)return this.mag.eCommerceCartManager.setCustomer(t.data),t.data},generateCustomerDataFromShippingForm(e){let t={email:e.email.value,name:e.name.value,shipping:{address:{country:e.country.value,city:e.city.value,line1:e.line1.value},name:e.name.value}};return e.phone.value&&(t.phone=e.phone.value,t.shipping.phone=e.phone.value),e.line2.value&&(t.shipping.address.line2=e.line2.value),e.postal_code.value&&(t.shipping.address.postal_code=e.postal_code.value),e.state.value&&(t.shipping.address.state=e.state.value),t},getInvoiceItemsForCustomer:async function(e){let t=this.mag.eCommerceCartManager.getCartData();return t.invoiceItems&&t.invoiceItems.length>0?t.invoiceItems:await this.createInvoiceItemsForCustomer(e)},createInvoiceItemsForCustomer:async function(e){let t=this.mag.eCommerceCartManager.getCartData(),i=Object.keys(t.prices).map(r=>({price:t.prices[r].id,quantity:t.prices[r].cart_count}));try{let r=await this.mag.eCommerceCartManager.createInvoiceItems(this.mag.num_id,e,i);if(r&&r.data&&r.data.length)return this.mag.eCommerceCartManager.setInvoiceItems(r.data),r.data}catch(r){console.error(r)}},getInvoiceForCustomer:async function(e){let t=this.mag.eCommerceCartManager.getCartData();if(t.invoice&&t.invoice.id){let i=await this.mag.eCommerceCartManager.getInvoice(this.mag.num_id,t.invoice.id);return i&&(i.status==="draft"||i.status==="open")?(this.mag.eCommerceCartManager.setInvoice(i),i):await this.createInvoiceForCustomer(e)}else return await this.createInvoiceForCustomer(e)},createInvoiceForCustomer:async function(e){let t=this.mag.eCommerceCartManager.getCartData(),i={customer:e,collection_method:"charge_automatically",auto_advance:!1};t.shippingForm&&t.shippingForm.note.value&&(i.metadata={customer_note:t.shippingForm.note.value});try{let r=await this.mag.eCommerceCartManager.createInvoice(this.mag.num_id,i);if(r&&r.data)return this.mag.eCommerceCartManager.setInvoice(r.data),r.data}catch(r){r&&r.type===q.nothingToInvoice&&(this.mag.eCommerceCartManager.clearCart(),this.goToInitialTab())}},createInvoiceWithItems:async function(){let e=await this.getCustomer();return await this.createInvoiceItemsForCustomer(e.id),await this.createInvoiceForCustomer(e.id)},cancelInvoice:async function(e){e.status==="draft"?await this.mag.eCommerceCartManager.deleteDraftInvoice(this.mag.num_id,e.id):(e.status==="open"||e.status==="uncollectible")&&await this.mag.eCommerceCartManager.voidDraftInvoice(this.mag.num_id,e.id),this.mag.eCommerceCartManager.unsetInvoiceItems(),this.mag.eCommerceCartManager.unsetInvoice()},createOrder(){this.showOrderLoader(),this.mag.eCommerceCartManager.updateCartData().then(function(){let e=this.generateOrderRequestData();e&&e instanceof Error?this.renderOrderError(e.message):e&&e.currency&&a.default.ajax({type:"POST",url:"/api/projects/"+this.mag.num_id+"/ecommerce/stripe/orders/",data:JSON.stringify(e),contentType:"application/json; charset=utf-8",dataType:"json",success:t=>{this.hideOrderLoader(),t&&t.data&&(this.mag.eCommerceCartManager.setOrder(t.data),this.renderOrderDetails())},error:t=>{let i=JSON.parse(t.responseText);this.hideOrderLoader(),this.renderOrderError(i.message)}})}.bind(this)).catch(function(e){this.hideOrderLoader(),e&&e.message&&this.renderOrderError(e.message)}.bind(this))},showOrderLoader(){this.orderLoading||(this.orderLoading=!0,this.$goToPayment.hasClass("hidden")||this.$goToPayment.addClass("hidden"),this.$orderTab.find(".preloader").addClass("show"),this.$orderDetails.addClass("hidden"))},hideOrderLoader(){this.orderLoading&&(this.orderLoading=!1,this.$goToPayment.hasClass("hidden")&&this.$goToPayment.removeClass("hidden"),this.$orderTab.find(".preloader").removeClass("show"),this.$orderDetails.removeClass("hidden"))},renderOrderDetails:async function(){let e=this.mag.eCommerceCartManager.getOrder();this.$orderItems.empty(),this.$orderShippingAddress.empty(),this.$orderShippingMethod.empty(),this.$orderShippingEmail.empty(),this.$orderTax.empty(),this.$orderTotalPrice.empty();let t,i;if(e.items.forEach(function(r){if(r.type==="tax")t=r;else if(r.type==="shipping")i=r;else{let s=(0,a.default)("<div/>",{class:"order-item"}).html(r.quantity+" \xD7 "+r.description),n=(0,a.default)("<div/>",{class:"order-item-price"}).text(l((r.amount/100).toFixed(2),r.currency));s.append(n),this.$orderItems.append(s)}}.bind(this)),e.shipping){let r=o=>o?` ${o}`:"",s=e.shipping.address,n=`${s.line1}${r(s.line2)} ${s.city},${r(s.state)}${r(s.postal_code)} ${s.country}`;this.$orderShippingAddress.text(n),this.$tabs.find(".shipping-details").removeClass("hidden")}else this.$tabs.find(".shipping-details").addClass("hidden");if(e.shipping_methods.length>1){let r=this.shippingMethodsOptions(e.shipping_methods),{default:s}=await import("https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-M4272OMK.js"),{default:n}=await import("https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-GXPKNDBF.js"),o=n.extend(s);this.shippingMethodSelect?(this.shippingMethodSelect.options=()=>r,this.shippingMethodSelect.value=i.parent):this.shippingMethodSelect=new o({el:this.$orderShippingMethod.get(0),propsData:{options:()=>r,value:i.parent,isDesktop:!1,callback:this.onShippingMethodChange}})}else this.$orderShippingMethod.parent(".shipping-method.order-row").removeClass("hidden"),this.$orderShippingMethod.text(i.description+" "+l((i.amount/100).toFixed(2),i.currency));this.$orderDetails.find(".order-id").text(String(e.id).slice(0,20)+"..."),e.email?(this.$orderShippingEmail.text(e.email),this.$orderDetails.find(".shipping-email").removeClass("hidden")):this.$orderDetails.find(".shipping-email").addClass("hidden"),e.phone?(this.$orderDetails.find(".order-shipping-phone").text(e.phone),this.$orderDetails.find(".shipping-phone").removeClass("hidden")):this.$orderDetails.find(".shipping-phone").addClass("hidden"),t&&(this.$orderTax.parent(".shipping-tax-size.order-row").removeClass("hidden"),this.$orderTax.text(t.description+" "+l((t.amount/100).toFixed(2),t.currency))),this.$orderTotalPrice.text(l((e.amount/100).toFixed(2),e.currency)),this.$goToPayment.removeClass("hidden")},shippingMethodsOptions(e){return e.map(t=>({value:t.id,caption:t.description+" "+l((t.amount/100).toFixed(2),t.currency)}))},onShippingMethodChange(e){this.shippingMethodSelect.value=e,this.showOrderLoader(),this.mag.eCommerceCartManager.changeShippingMethod(e).then(t=>{this.hideOrderLoader(),t.data&&(this.mag.eCommerceCartManager.setOrder(t.data),this.renderOrderDetails())}).catch(()=>{this.hideOrderLoader()})},renderOrderError:function(e=""){this.$orderError.find(".order-error-message").text(e),this.$orderError.removeClass("hidden"),this.$orderDetails.addClass("hidden"),this.$goToPayment.addClass("hidden")},clearOrderError:function(){this.$orderError.addClass("hidden"),this.$orderDetails.removeClass("hidden"),this.$goToPayment.removeClass("hidden")},transformShippingFormToOrderRequest(){let e=this.checkShippableInCart(),t={currency:"usd",email:this.shippingForm.email.value,items:[]};return this.shippingForm.note.value&&(t.metadata={note:this.shippingForm.note.value}),e&&(t.shipping={name:this.shippingForm.name.value,phone:this.shippingForm.phone.value,address:{line1:this.shippingForm.line1.value,line2:this.shippingForm.line2.value,city:this.shippingForm.city.value,state:this.shippingForm.state.value,country:this.shippingForm.country.value,postal_code:this.shippingForm.postal_code.value}}),t},generateOrderRequestData:function(){let e=this.mag.eCommerceCartManager.getCartData();if(!e||!e.skus)return new Error("Empty cart");let t=[],i=this.transformShippingFormToOrderRequest();for(let r in e.skus)e.skus[r].active&&(i.items.push({type:e.skus[r].object,parent:r,currency:e.skus[r].currency,quantity:e.skus[r].cart_count}),t.indexOf(e.skus[r].currency)===-1&&t.push(e.skus[r].currency));return t.length>1?new Error("mixed currencies"):(i.currency=t.pop(),i)},cancelOrder:function(){if(this.showPaymentLoader(),this.havePrices){let e=this.mag.eCommerceCartManager.getCartData();e.invoice&&this.cancelInvoice(e.invoice).then(()=>{this.hidePaymentLoader(),this.goToTabByClassname(".tab-items")}).catch(()=>{this.hidePaymentLoader()})}else this.mag.eCommerceCartManager.cancelOrder().then(e=>{this.hidePaymentLoader(),e.data&&e.data.status==="canceled"&&(this.mag.eCommerceCartManager.deleteOrder(),this.goToTabByClassname(".tab-items"))}).catch(()=>{this.hidePaymentLoader()})},renderCheckoutFormPaymentIntent:async function(){let e=this.mag.eCommerceCartManager.getCustomer();if(!e){this.$paymentFailed.text("Customer not found");return}let t=await this.getInvoiceForCustomer(e.id);if(!t){this.$paymentFailed.text("Invoice not found");return}let i=this.mag.eCommerceCartManager.getCartData();if(this.showPaymentLoader(),t.status==="draft"){let n=await this.mag.eCommerceCartManager.finalizeInvoice(this.mag.num_id,t.id);this.mag.eCommerceCartManager.setInvoice(n);let o=await this.mag.eCommerceCartManager.getPaymentIntent(this.mag.num_id,n.payment_intent);o.receipt_email||await this.mag.eCommerceCartManager.updatePaymentIntent(this.mag.num_id,o.id,{receipt_email:i.shippingForm.email.value}),this.clientSecret=o.client_secret,this.hidePaymentLoader()}else if(t.status==="open"){let n=await this.mag.eCommerceCartManager.getPaymentIntent(this.mag.num_id,t.payment_intent);n.receipt_email||await this.mag.eCommerceCartManager.updatePaymentIntent(this.mag.num_id,n.id,{receipt_email:i.shippingForm.email.value}),this.clientSecret=n.client_secret,this.hidePaymentLoader()}let r=I(this.mag.eCommerceManager.ecommerceData);this.stripe||(this.stripe=Stripe(E,{stripeAccount:r}));let s=this.stripe.elements();this.cardNumber||(this.cardNumber=s.create("cardNumber",{style:this.cardStyle,placeholder:"Card number",showIcon:!0}),this.cardNumber.mount("#card-number-element"),this.cardNumber.addEventListener("change",n=>{let o=this.$paymentTab.find(".card-number-error");n.error?o.removeClass("hidden"):o.addClass("hidden")}),this.cardNumber.addEventListener("ready",()=>{this.renderCartHolderInput()})),this.cardExpiry||(this.cardExpiry=s.create("cardExpiry",{style:this.cardStyle,placeholder:"M/Y"}),this.cardExpiry.mount("#card-expiry-element"),this.cardExpiry.addEventListener("change",n=>{let o=this.$paymentTab.find(".card-expiry-error");n.error?o.removeClass("hidden"):o.addClass("hidden")})),this.cardCvc||(this.cardCvc=s.create("cardCvc",{style:this.cardStyle,placeholder:"Security code"}),this.cardCvc.mount("#card-cvc-element"),this.cardCvc.addEventListener("change",n=>{let o=this.$paymentTab.find(".card-cvc-error");n.error?o.removeClass("hidden"):o.addClass("hidden")})),this.form||(this.form=document.getElementById("payment-form"),this.form.addEventListener("submit",this.onPaymentFormSubmit.bind(this)))},renderCheckoutForm:function(){let e=I(this.mag.eCommerceManager.ecommerceData);this.stripe||(this.stripe=Stripe(E,{stripeAccount:e}));let t=this.stripe.elements();this.cardNumber||(this.cardNumber=t.create("cardNumber",{style:this.cardStyle,placeholder:"Card number",showIcon:!0}),this.cardNumber.mount("#card-number-element"),this.cardNumber.addEventListener("change",i=>{let r=this.$paymentTab.find(".card-number-error");i.error?r.removeClass("hidden"):r.addClass("hidden")}),this.cardNumber.addEventListener("ready",()=>{this.renderCartHolderInput()})),this.cardExpiry||(this.cardExpiry=t.create("cardExpiry",{style:this.cardStyle,placeholder:"M/Y"}),this.cardExpiry.mount("#card-expiry-element"),this.cardExpiry.addEventListener("change",i=>{let r=this.$paymentTab.find(".card-expiry-error");i.error?r.removeClass("hidden"):r.addClass("hidden")})),this.cardCvc||(this.cardCvc=t.create("cardCvc",{style:this.cardStyle,placeholder:"Security code"}),this.cardCvc.mount("#card-cvc-element"),this.cardCvc.addEventListener("change",i=>{let r=this.$paymentTab.find(".card-cvc-error");i.error?r.removeClass("hidden"):r.addClass("hidden")})),this.form||(this.form=document.getElementById("payment-form"),this.form.addEventListener("submit",this.onPaymentFormSubmit.bind(this)))},renderCartHolderInput(){this.cardHolderName||(this.cardHolderName=this.$paymentTab.find(".card-name-input"),this.cardHolderName.removeClass("hidden"),this.cardHolderName.on("input",this.onCardHolderNameChange))},onCardHolderNameChange(e){this.cardHolderNameValue=e.target.value,this.cardHolderNameValue?this.$paymentTab.find(".card-name-error").hasClass("hidden")||this.$paymentTab.find(".card-name-error").addClass("hidden"):this.$paymentTab.find(".card-name-error").hasClass("hidden")&&this.$paymentTab.find(".card-name-error").removeClass("hidden")},onPaymentFormSubmit(e){if(e.preventDefault(),this.cardHolderNameValue)this.$paymentTab.find(".card-name-error").addClass("hidden");else{this.$paymentTab.find(".card-name-error").removeClass("hidden");return}this.haveSkus?this.onSkuPaymentFormSubmit():this.havePrices&&this.onPricesPaymentFormSubmit()},onSkuPaymentFormSubmit(){this.stripe.createToken(this.cardNumber,{name:this.cardHolderNameValue}).then(e=>{e.error||this.stripeTokenHandler(e.token)})},onPricesPaymentFormSubmit(){if(!this.clientSecret){this.showErrorPaymentMessage("Not client secret");return}this.hideErrorPaymentMessage(),this.showPaymentLoader(),this.stripe.confirmCardPayment(this.clientSecret,{payment_method:{card:this.cardNumber,billing_details:{name:this.cardHolderNameValue}}}).then(e=>{e.error?(this.hidePaymentLoader(),this.showErrorPaymentMessage("Payment Failed on confirmCardPayment"),this.checkoutComplete=!0):(this.hidePaymentLoader(),e.paymentIntent.status==="succeeded"&&(this.showSuccessPaymentMessage(),RM.analytics&&RM.analytics.sendEvent("Checkout success")),this.checkoutComplete=!0)})},stripeTokenHandler:function(e,t){let i=this.mag.eCommerceCartManager.getOrder();if(!i){this.showErrorPaymentMessage("Order not found");return}let r=i.email;if(!r){this.showErrorPaymentMessage("Email is required");return}this.hideErrorPaymentMessage(),this.showPaymentLoader(),a.default.ajax({type:"POST",url:"/api/projects/"+this.mag.num_id+"/ecommerce/stripe/orders/"+i.id+"/pay/",data:JSON.stringify({stripe_token:e.id,email:r}),contentType:"application/json; charset=utf-8",dataType:"json",success:function(s){this.hidePaymentLoader(),s&&s.data&&(s.data.status==="paid"&&(RM.analytics&&RM.analytics.sendEvent("Checkout success"),this.showSuccessPaymentMessage(),typeof t=="function"&&t({status:"success"})),this.checkoutComplete=!0)}.bind(this),error:function(){this.hidePaymentLoader(),this.showErrorPaymentMessage("Payment Failed"),typeof t=="function"&&t({status:"fail"}),this.checkoutComplete=!0}.bind(this)})},showPaymentLoader(){this.paymentLoading||(this.paymentLoading=!0,this.$paymentTab.find(".preloader").addClass("show"),this.$paymentTab.find(".cart-payment-btn").css("display","none"),this.$paymentTab.find(".cart-cancel-btn").css("display","none"))},hidePaymentLoader(){this.paymentLoading&&(this.paymentLoading=!1,this.$paymentTab.find(".preloader").removeClass("show"),this.$paymentTab.find(".cart-payment-btn").css("display","block"),this.$paymentTab.find(".cart-cancel-btn").css("display","block"))},showErrorPaymentMessage(e=""){this.$paymentFailed.find(".error-message").text(e),this.$paymentFailed.addClass("show")},hideErrorPaymentMessage(){this.$paymentFailed.find(".error-message").empty(),this.$paymentFailed.removeClass("show")},showSuccessPaymentMessage(){this.$paymentTab.find(".sidebar-header").css("display","none"),this.$paymentTab.find(".sidebar-body").css("display","none"),this.$paymentSuccess.addClass("show")},hideSuccessPaymentMessage(){this.$paymentTab.find(".sidebar-header").css("display","block"),this.$paymentTab.find(".sidebar-body").css("display","block"),this.$paymentSuccess.removeClass("show")},toogleSettings:function(){this.isHiddenSettings=!this.isHiddenSettings,this.settingsPanel&&(this.settingsPanel.isHidden=this.isHiddenSettings)},setupSettingsPanel:function(){},onModelChange(e){this.saveModelChanges_debounced(e)},saveModelChanges(e){this.updateCartWidgetData(e),this.generateSidebarCSS(this.cartWidgetData),this.cartWidgetModel&&this.cartWidgetModel.save(e,{toHistory:!1,skipHistory:!0,patch:!0}).then(()=>{this.renderSidebarTexts()})},updateCartWidgetData(e={}){this.cartWidgetData={...this.cartWidgetData,...e}},checkShippableInCart:function(){let e=this.mag.eCommerceCartManager.getCartData();for(let t in e.skus)if(e.skus[t].productObject.shippable)return!0;return!1},destroy:function(){if(this.rendered)return this.checkoutComplete&&(this.mag.eCommerceCartManager.clearCart(),this.goToInitialTab(),this.hideSuccessPaymentMessage(),this.$paymentFailed.empty()),f.off("ecommerce:cartsidebar:visibility:changed"),f.off("ecommerce:cartdata:changed"),this.form&&this.form.removeEventListener("submit",this.onPaymentFormSubmit),this.cardHolderName&&this.cardHolderName.off("input",this.onCardHolderNameChange),this.$tabs.find("[data-tab^='tab-']").each(function(e,t){(0,a.default)(t).off("click")}),this.$items.find(".cart-item-remove-btn").each(function(e,t){(0,a.default)(t).off("click")}),this.$tabs.find(".order-details-form .form-input").each((e,t)=>{(0,a.default)(t).off("input",this.onShippingFormChange)}),this.unbindDomEvents(),this.settingsPanel&&(this.settingsPanel.$off("change",this.onModelChange),this.settingsPanel.$destroy()),this.$settingButton&&this.$settingButton.off("click",this.toogleSettings),this.environment===c.environment.preview&&this.unbindTextInputsEvents(),this.remove()},cartItemBlockHover:function(e){let t=(0,a.default)(e.currentTarget);t&&t.length&&(t.addClass("hover").siblings().removeClass("hover"),this.hoveredItem=t.data("price-id")||t.data("sku-id"))},cartItemBlockLeave:function(e){let t=(0,a.default)(e.currentTarget);t&&t.length&&(t.removeClass("hover"),(t.data("price-id")||t.data("sku-id"))===this.hoveredItem&&(this.hoveredItem=null))}}),we=ge;export{we as a};
