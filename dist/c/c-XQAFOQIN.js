import{b as O,c as T,d as E,g as I}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-CHHTJHXI.js";import{a as K}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-RYISFIXI.js";import{a as w,p as G}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-SJHL2R4Y.js";import{l as o,m as _}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-42TSFLLH.js";import{a as H}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-JTEJSVZP.js";import{g as k,h as M}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-VUD7OPNE.js";import{D as J,h as D}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-M4TEEAX7.js";import{b as p,c as V}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-SXBIDYQQ.js";import{b as W,c as P,e as U}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-GJYOXBH4.js";import{a as q}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-3SFTLRL3.js";import{b as B}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-W2OJRSJR.js";import{a as S,d as f}from"https://st-p.rmcdn1.net/e0cde9ba/dist/c/c-TZYDFHR2.js";var g,j=S(()=>{"use strict";_();I();g=class{onMagFullLoaded(e){e.addStripeLibrary();let r=new URL(window.location.href),a=new URLSearchParams(window.location.search),i=a.get("checkout_status"),s=a.get("session_id"),u=a.get("mode");a.delete("checkout_status"),a.delete("session_id"),a.delete("mode");let h=a.toString();if(window.history.replaceState({},document.title,r.pathname+(h?`?${h}`:"")),i&&i==="success"&&(e.clearCart(),e.openSidebarOnRender={checkoutComplete:!0},s&&u==="subscription"&&T(e.mag.num_id,s).then(c=>c.data).then(c=>c?.id&&E(e.mag.num_id,{customer:c.id,return_url:window.location.href.split("?")[0]})).then(({data:c})=>{c?.url&&o.trigger("ecommerce:billingPortalUrl:get",c.url)}),"sessionStorage"in window))try{let c="stripePurchaseEvent",m=window.sessionStorage.getItem(c);if(m){let F=JSON.parse(m),b=setInterval(()=>{window.RM.analytics&&(clearInterval(b),window.RM.analytics.sendEvent("purchase",{ecommerceData:F}))},100);setTimeout(()=>clearInterval(b),3e3),window.sessionStorage.removeItem(c)}}catch(c){console.error("Cannot send GA analytics: ",c)}}checkProductActive(e){return e.active&&(this.productHasActiveSku(e)||this.productHasActivePrice(e))}productHasActiveSku(e){return Array.isArray(e?.articles)&&e.articles.some(r=>r.active)}productHasActivePrice(e){return e&&e.prices&&e.prices.length&&e.prices.some(r=>r.active)}mapProductsSelectList(e=[],r){let a=e.filter(i=>i.active&&(i.articles&&i.articles.length||i.prices&&i.prices.length)||r&&r===i.id).map(i=>({value:i.id,caption:i.name}));return a.unshift({value:"default",caption:"None"}),a}getProductForAddToCart(e,r){if(!e)return null;let a=this.getActivePrice(e);if(a)return a.productObject={...e,articles:null,prices:null},a;let i=this.getSkuBySelectsValues(e,r);return i?(i.productObject={...e,articles:null,prices:null},i):null}getActivePrice(e){return Array.isArray(e.prices)?e.prices.find(a=>a.active&&a.billing_scheme==="per_unit"):null}getSkuBySelectsValues(e,r){return!e||!Array.isArray(e.articles)||e.articles.length===0?null:e.articles.length===1?e.articles[0]:e.articles.find(a=>JSON.stringify(a.attributes)===JSON.stringify(r))}}});var y,A=S(()=>{"use strict";y=class{onMagFullLoaded(e){return null}checkProductActive(e){return!!e?.active}productHasActiveSku(e){return e?.options&&e.options.some(r=>this.isOptionValid(r))}isOptionValid(e){return["SELECT","SIZE","RADIO"].includes(e?.type)}mapProductsSelectList(e=[],r){let a=e.map(i=>({value:i.id,caption:i.name}));return a.unshift({value:"default",caption:"None"}),r&&!a.find(i=>i.value===r)&&a.push({value:r,caption:"inactive product"}),a}getProductForAddToCart(e,r){let a={...e};if(a&&r&&(a.selectedOptions={...r},Array.isArray(a.combinations))){let i=a.combinations.find(s=>s.options.every(u=>r[u.name]===u.value));i&&(a.selectedCombination={...i})}return a}getProductQuantity(e){return(e?.selectedCombination||e)?.quantity}isProductAvailable(e){if(e?.inStock){let r=this.getProductQuantity(e);if(typeof r>"u"||r)return!0}return!1}countCartItemsById(e,r){let a=0;return Object.keys(r.prices).forEach(i=>{let s=r.prices[i];s&&(s.id===e||s.selectedCombination?.id===e)&&(a+=s.cart_count||0)}),a}isOutOfStock(e,r){if(!e)return!0;let a=this.getProductQuantity(e);if(typeof a>"u")return!1;let i=this.countCartItemsById(e.selectedCombination?e.selectedCombination.id:e.id,r);return!!(a&&i+1>a)}updateCartProductItems(e,r){let a={...r};return a.prices={},Object.keys(r.prices).forEach(i=>{let s=r.prices[i],u=e.find(h=>h.id===s.id);if(u){if(a.prices[i]={...s,...u},s.selectedCombination&&u.combinations){let h=u.combinations.find(c=>c.id===s.selectedCombination?.id);h&&(a.prices[i].selectedCombination=h)}}else s&&(a.prices[i]={...s})}),a}}});function R(t){let e=0,r="",a=[];for(let i of t){let s=(i.unit_amount/100).toFixed(2);e+=s*i.cart_count,r=i.currency.toUpperCase(),a.push({item_id:i.id,item_name:i.productObject?.name,price:s,quantity:i.cart_count})}return{value:e,currency:r,items:a}}var x,v,d,$,N,L,l,n,Q,C,pt,Y=S(()=>{"use strict";x=f(H()),v=f(B()),d=f(q()),$=f(K());M();J();_();V();j();A();I();G();W();U();N=()=>({skus:{},prices:{},uniqSkusCount:0,uniqPricesCount:0,shippableProducts:0,changed:new Date().toISOString(),order:null,provider:null}),L={out_of_stock:"Out of stock"},l={outOfStock:"outOfStock",nothingToInvoice:"nothingToInvoice"},n=class extends Error{constructor(e,r){super(e),this.type=r}},Q=["stripe","ecwid"],C=function({router:t,mag:e,environment:r,page:a,products:i}){RM.screenshot&&(this.page=a),this.isMagLoaded=!1,this.haveEcommerceCartWidget=!1,this.isCartSidebarHidden=!0,this.productsLoading=!1,this.productsLoaded=!1,this.productsLoadingError=!1,this.cancelingOrder=!1,this.products=null,this.storageKey="_rmcartdata",this.connectedProvider,this.openSidebarOnAddItem=!1,this.environment=r,this.mag=e,this.router=t,this.events=v.default.extend({},x.default.Events),this.cartData=N(),this.cartItemsLimit=25;let s=window.navigator.language;return this.userLocale=s?s.substring(0,2):"en",i&&(this.products=i),this.isConstructor()?this.mag.has("_id")?this.onMagFullLoaded():o.once("mag:loadfull:complete",this.onMagFullLoaded,this):(this.mag.model.has("_id")&&this.onMagFullLoaded(),this.restoreBackupCartData()),this};v.default.extend(C.prototype,{ecommerceProviders:Q,CONNECTION_TIMEOUT:5e3,stripeJsSrc:"https://js.stripe.com/v3/",isConstructor:function(){return this.environment===p.environment.constructor},isViewer:function(){return this.environment===p.environment.viewer},isPreview:function(){return this.environment===p.environment.preview},getStorageKey(){return`${this.storageKey}_${this.mag.num_id}`},onMagFullLoaded:function(){this.isMagLoaded||(this.isMagLoaded=!0,this.haveEcommerceCartWidget=this.hasEcommerceWidget(),this.connectedProvider=this.getConnectedProvider(),this.cartData.provider=this.connectedProvider,this.connectEcommerceAdapter(),this.events.trigger("ecommerce:update:provider",this.connectedProvider),this.connectedProvider&&!this.productsLoading&&(this.adapter.onMagFullLoaded(this),this.products||this.getProducts(this.connectedProvider)))},hasEcommerceWidget:function(){let t=this.isConstructor()?this.mag.globalWidgets:RM.screenshot?this.page.widgetsData:[...this.mag.staticGlobalWidgetsData,...this.mag.aboveGlobalWidgetsData];return C.hasEcommerceWidget(this.environment,t)},getEcommerceData:function(){let t=null;return this.isConstructor()?this.mag.has("ecommerce_data")&&(t=this.mag.get("ecommerce_data")):this.mag.model.has("ecommerce_data")&&(t=this.mag.model.get("ecommerce_data")),t},connectEcommerceAdapter:function(){if(!this.connectedProvider){this.adapter=null;return}switch(this.connectedProvider){case"stripe":this.adapter=new g;break;case"ecwid":this.adapter=new y;break}},updateEcommerceDataFromServer(){w(this.mag.get("num_id")).then(t=>{t?.ecommerce_data&&(this.mag.set({ecommerce_data:t.ecommerce_data},{silent:!0}),this.connectedProvider=this.getConnectedProvider(),this.cartData.provider=this.connectedProvider,this.connectEcommerceAdapter(),this.events.trigger("ecommerce:update:provider",this.connectedProvider))})},getStripeConnectedUserId:function(){if(!this.isMagLoaded)return null;let t=this.getEcommerceData();return t&&t.stripe&&t.stripe.stripe_data&&t.stripe.stripe_data.stripe_user_id?t.stripe.stripe_data.stripe_user_id:null},getProducts:async function(t){if(this.productsLoading=!0,window.RM.common.isDownloadedSource&&this.mag.ecommerce_data[t].products)return this.products=this.mag.ecommerce_data[t].products,this.productsLoaded=!0,this.productsLoading=!1,this.products;let e=this.isConstructor()?this.mag.get("num_id"):this.mag.model.get("num_id"),r=this.isViewer()?"published_projects":"projects",a=RM.screenshot&&RM.screenshotMode==="preview"?"?type=preview":this.isViewer()?"?type=published":"",i=t==="stripe"?`/api/${r}/${e}/ecommerce/stripe/products/`:`/api/ecommerce/${e}/${t}/products${a}`;return d.default.ajax({type:"GET",url:i,context:this}).done(s=>(s&&s.data&&(this.products=s.data),this.productsLoaded=!0,this.events.trigger("ecommerce:loadproducts:complete"),this.products)).fail(s=>{throw s.status,this.productsLoadingError=!0,this.events.trigger("ecommerce:loadproducts:complete"),new n("Loading products error")}).always(()=>{this.productsLoading=!1})},setProducts:function(t){t&&(this.products=t,this.productsLoaded=!0,this.events.trigger("ecommerce:loadproducts:complete"))},updateCartProductItems:async function(){let t=this.adapter?.updateCartProductItems(this.products,this.cartData);if(t)return this.cartData=t,this.markCartChange(),this.backupCartData(),o.trigger("ecommerce:cartdata:changed",this.cartData),this.cartData;throw new n("Update cart data error")},addStripeLibrary:function(){if(this.isConstructor()||window.Stripe&&window.Stripe.version)return;let t=document.createElement("script"),e=document.getElementsByTagName("body")[0];t.setAttribute("async","async"),t.setAttribute("src",this.stripeJsSrc),e.appendChild(t)},getConnectedProvider:function(){let t;return this.ecommerceProviders.forEach(e=>{this.isMagConnectedTo(e)&&(t=e)}),t},isMagConnectedTo:function(t){if(!this.isMagLoaded||!this.ecommerceProviders.includes(t))return!1;let e=this.getEcommerceData();return e?!!(e[t]&&e[t].status&&e[t].status==="connected"):!1},canBeConnectedTo:function(t){if(!this.isConstructor())return!1;let e=this.getConnectedProvider();return!(e&&t!==e)},connectToStripe:function(){return new Promise(function(t,e){window.open("/api/connect/ecommerce/stripe/connect?num_id="+this.mag.get("num_id"),"_blank"),this.initSocket().then(function(r){this.mag.set({ecommerce_data:r},{silent:!0}),t()}.bind(this)).catch(function(r){e(r)})}.bind(this))},disconnectFrom:function(t){return new Promise(function(e,r){d.default.ajax({type:"GET",url:`/api/connect/ecommerce/${t}/disconnect?num_id=${this.mag.get("num_id")}`,success:function(a){if(a&&a.status){this.products=null;let i=this.getEcommerceData();i[t]||(i[t]={}),i[t]=a,this.mag.set({ecommerce_data:i},{silent:!0})}e(a)},error:function(a){r(a)},context:this})}.bind(this))},getTextValue:function(t){let r=this.getEcommerceData()?.texts?.[t];return r?k.sanitize(r):L[t]},saveTextValue:function(t,e){let r=this.getEcommerceData();r.texts||(r.texts={});let a=e||L[t];r.texts[t]=a,this.mag.save({ecommerce_data:r},{patch:!0})},initSocket:function(){return new Promise(function(t,e){let r=window.location.origin===p.readymag_auth_host,a=r&&p.isProd?"sockets.readymag.com/stripe-auth":"/stripe-auth";P("constructor.socketsHostFromEnv")&&(a=r&&p.readymag_sockets_host?`${p.readymag_sockets_host}/stripe-auth`:"/stripe-auth");let i=io(a,{timeout:this.CONNECTION_TIMEOUT,transports:["websocket"]});i.on("connect",function(){i.emit("wainting for mag stripe auth update",{num_id:this.mag.get("num_id"),user:this.router.me.pick("name","email","_id"),hash:this.mag.get("socket_hash")}),i.on("state-update",function(s){i.disconnect(),s.error?e(s.error):t(s.ecommerce_data)})}.bind(this))}.bind(this))},checkCartDisabledControls:function(){if(this.haveEcommerceCartWidget){let t=this.getEcommerceCartBlock(),e=this.getEcommerceData();t&&t.checkDisabledControls(e.stripe&&e.stripe.status&&e.stripe.status==="connected")}},getEcommerceCartBlock(){return this.haveEcommerceCartWidget&&this.isConstructor()?this.router.workspace.findBlockByFunction(function(t){return t.attributes.type==="ecommercecart"}):null},getCartWidgetData(){if(!this.isConstructor()){let t=this.mag.staticGlobalWidgetsData.find(e=>e.type==="ecommercecart");return t||this.mag.aboveGlobalWidgetsData.find(e=>e.type==="ecommercecart")}return null},getProductsLikeOptionsList(t){return this.products&&this.adapter?this.adapter.mapProductsSelectList(this.products,t):[]},checkProductActive(t){if(!t)return;let e=this.getProductById(t);if(e)return this.adapter?this.adapter.checkProductActive(e):!1},productHasActiveSku(t){return t&&this.adapter?this.adapter.productHasActiveSku(t):!1},isOptionValid(t){return this.adapter&&this.adapter.isOptionValid(t)},isSkuAvailable:function(t){return t.active?t.inventory.type==="infinite"||t.inventory.type==="finite"&&t.inventory.quantity>0||t.inventory.type==="bucket"&&(t.inventory.value==="in_stock"||t.inventory.value==="limited"):!1},getProductById(t){return this.products&&Array.isArray(this.products)?this.products.find(function(e){return e.id===t}):null},getSkusByProductId:function(t){let e=this.getProductById(t);return e?e.articles:null},getFirstAvailableSku:function(t){return t?t.find(function(e){return this.isSkuAvailable(e)}.bind(this)):null},getFirstAvailableSkuForProductId:function(t){return this.getFirstAvailableSku(this.getSkusByProductId(t))},changeCartSidebarVisibility:function(){if(!(this.isCartSidebarHidden&&this.isViewer()&&!this.getConnectedProvider()))return this.isCartSidebarHidden=!this.isCartSidebarHidden,o.trigger("ecommerce:cartsidebar:visibility:changed",this.isCartSidebarHidden),this.isCartSidebarHidden},openCartSidebar:function(){this.isCartSidebarHidden&&this.changeCartSidebarVisibility()},checkItemQuantity:function(t){if(typeof t=="string"){if(this.cartData.skus[t]){let e=this.cartData.skus[t];return e.inventory.type==="infinite"||e.inventory.type==="finite"&&e.cart_count<e.inventory.quantity||e.inventory.type==="bucket"&&e.inventory.value!=="out_of_stock"}}else{let e=t;return!!(e.inventory.type==="infinite"||e.inventory.type==="finite"&&e.inventory.quantity||e.inventory.type==="bucket"&&e.inventory.value!=="out_of_stock")}return!1},checkItemQuantityOnUpdate(t){if(this.cartData.skus[t]){let e=this.cartData.skus[t];return e.inventory.type==="infinite"||e.inventory.type==="finite"&&e.cart_count<=e.inventory.quantity||e.inventory.type==="bucket"&&e.inventory.value!=="out_of_stock"}return!1},getCartData:function(){return this.cartData},markCartChange:function(){this.cartData.changed=new Date().toISOString()},isProductAvailable(t){return this.adapter?.isProductAvailable(t)},isOutOfStock(t){return this.adapter?.isOutOfStock(t,this.cartData)},getProductForAddToCart(t,e){return this.adapter?.getProductForAddToCart(t,e)},addProductToCart(t){switch(t.object){case"price":return this.addPriceToCart(t);case"product":return this.addEcwidToCart(t);case"sku":return this.addSkuToCart(t);default:return new n("provider not found")}},addSkuToCart:function(t){if(!t||!t.id)return new n("Sku data isn't valid or doesn\u2019t have an id");if(this.cartData.skus[t.id])if(this.checkItemQuantity(t.id))this.cartData.skus[t.id]=Object.assign({},t,{cart_count:this.cartData.skus[t.id].cart_count+1});else return new n("You can\u2019t add this product with attribute "+t.id+". It's out of stock",l.outOfStock);else{if(this.cartData.uniqSkusCount+1>this.cartItemsLimit)return new n("You can\u2019t add more than "+this.cartItemsLimit+" items to the cart");if(!this.checkItemQuantity(t))return new n("You can\u2019t add this product with attribute "+t.id+". It's out of stock",l.outOfStock);this.cartData.skus[t.id]=Object.assign({},t,{cart_count:1}),this.cartData.uniqSkusCount+=1,t.productObject.shippable&&(this.cartData.shippableProducts+=1)}return this.markCartChange(),this.backupCartData(),o.trigger("ecommerce:cartdata:changed",this.cartData),this.openSidebarOnAddItem&&this.openCartSidebar(),this.cartData},addPriceToCart(t){if(!t||!t.id||!t.active)return new n("Price data isn't valid or doesn\u2019t have an id");if(this.cartData.prices[t.id])this.cartData.prices[t.id]=Object.assign({},t,{cart_count:this.cartData.prices[t.id].cart_count+1});else{if(this.cartData.uniqPricesCount+1>this.cartItemsLimit)return new n("You can\u2019t add more than "+this.cartItemsLimit+" items to the cart");this.cartData.prices[t.id]=Object.assign({},t,{cart_count:1}),this.cartData.uniqPricesCount+=1}return this.markCartChange(),this.backupCartData(),o.trigger("ecommerce:cartdata:changed",this.cartData),this.openSidebarOnAddItem&&this.openCartSidebar(),this.cartData},addEcwidToCart(t){if(!t||!t.id)return new n("Product data isn't valid or doesn\u2019t have an id");let e=this.getCartItenKey(t);return this.isProductAvailable(t)?this.isOutOfStock(t)?new n(`You can\u2019t add more product ${t.id} items to the cart`,l.outOfStock):(this.cartData.prices[e]?this.cartData.prices[e].cart_count+=1:(this.cartData.prices[e]={cart_count:1,...t},this.cartData.uniqPricesCount+=1),this.markCartChange(),this.backupCartData(),o.trigger("ecommerce:cartdata:changed",this.cartData),this.openSidebarOnAddItem&&this.openCartSidebar(),this.cartData):new n(`You can\u2019t add this product ${t.id}. It's out of stock`,l.outOfStock)},getCartItenKey(t){return t.object==="product"&&t.selectedOptions&&Object.keys(t.selectedOptions).length>0?(0,$.default)(`${t.id}-${JSON.stringify(t.selectedOptions)}`):t.id},increaseCartItem:function(t){this.cartData.prices[t]&&(this.cartData.prices[t].cart_count+=1,this.markCartChange(),this.backupCartData(),o.trigger("ecommerce:cartdata:changed",this.cartData))},increaseSkuCartItem:function(t){if(this.cartData.skus[t])if(this.checkItemQuantity(t))this.cartData.skus[t].cart_count+=1,this.markCartChange(),this.backupCartData(),o.trigger("ecommerce:cartdata:changed",this.cartData);else return new n("You can\u2019t add more this product with attribute "+t+". It's out of stock",l.outOfStock)},decreaseCartItem:function(t){this.cartData.prices[t]&&this.cartData.prices[t].cart_count>1&&(this.cartData.prices[t].cart_count-=1,this.markCartChange(),this.backupCartData(),o.trigger("ecommerce:cartdata:changed",this.cartData))},decreaseSkuCartItem:function(t){this.cartData.skus[t]&&this.cartData.skus[t].cart_count>1&&(this.cartData.skus[t].cart_count-=1,this.markCartChange(),this.backupCartData(),o.trigger("ecommerce:cartdata:changed",this.cartData))},removeFromCart:function(t){if(this.cartData.prices[t]){let e=this.cartData.prices[t];return delete this.cartData.prices[t],this.cartData.uniqPricesCount-=1,this.markCartChange(),this.backupCartData(),o.trigger("ecommerce:cartdata:changed",this.cartData),e}},removeSkuFromCart:function(t){if(this.cartData.skus[t]){let e=this.cartData.skus[t];return this.cartData.skus[t].productObject.shippable&&(this.cartData.shippableProducts-=1),delete this.cartData.skus[t],this.cartData.uniqSkusCount-=1,this.markCartChange(),this.backupCartData(),o.trigger("ecommerce:cartdata:changed",this.cartData),e}},clearCart(){this.cartData=N(),this.backupCartData(),o.trigger("ecommerce:cartdata:changed",this.cartData)},createCheckoutSession({showPromoCodes:t,shippingRates:e,shippingAddressCollection:r}){let a="stripePurchaseEvent";if("sessionStorage"in window){let m=R(Object.values(this.cartData.prices));window.sessionStorage.setItem(a,JSON.stringify(m))}let i=!1,s=[];Object.keys(this.cartData.prices).forEach(m=>{s.push({price:this.cartData.prices[m].id,quantity:this.cartData.prices[m].cart_count}),this.cartData.prices[m].type==="recurring"&&(i=!0)});let u=window.location.href.split("?")[0],h=i?"subscription":"payment",c={line_items:s||[],success_url:`${u}?checkout_status=success&mode=${h}&session_id={CHECKOUT_SESSION_ID}`,cancel_url:`${u}?checkout_status=cancel`,payment_method_types:["card"],mode:h,allow_promotion_codes:t};return!i&&e&&r&&(c.shipping_rates=e,c.shipping_address_collection=r),O(this.mag.num_id,c)},updateCartSkus:function(t){let e=[];if(t.forEach(r=>{this.cartData.skus[r.id]&&(this.cartData.skus[r.id]=Object.assign({},this.cartData.skus[r.id],r),this.checkItemQuantityOnUpdate(r.id)||e.push(this.cartData.skus[r.id].productObject.name))}),this.backupCartData(),e.length)return e},updateCartData:function(){return new Promise(function(t,e){(!this.cartData||!this.cartData.skus)&&e(new n("Empty cart"));let r=[];for(let i in this.cartData.skus)this.cartData.skus.hasOwnProperty(i)&&r.push(i);let a=r.length?v.default.uniq(r).join(","):null;d.default.ajax({type:"GET",url:"/api/projects/"+this.mag.num_id+"/ecommerce/stripe/skus/"+(a?"?skus_ids="+a:""),contentType:"application/json; charset=utf-8",dataType:"json",success:function(i){if(i&&i.data){let s=this.updateCartSkus(i.data);if(s){let u=s.length>1;e(new n(`This item${u?"s":""} cannot be used to create an order: ${s.join(", ")} ${u?"are":"is"} out of stock`,l.outOfStock))}t(this.cartData)}}.bind(this),error:function(){e(new n("Error occurred while updating the skus:",r))}})}.bind(this))},hasShippableProducts(){return!!this.cartData.shippableProducts||!!this.cartData.uniqPricesCount},setShippingForm(t){this.cartData.shippingForm=D(t),this.markCartChange(),this.backupCartData()},getShippingForm(){return D(this.cartData.shippingForm)},getShippingOptions(){return!this.cartData.order||!this.cartData.order.shipping_methods?null:this.cartData.order.shipping_methods.map(t=>({id:t.id,label:t.description,amount:t.amount}))},setOrder:function(t){this.cartData.order=t,this.backupCartData()},getOrder:function(){return this.cartData.order},deleteOrder:function(){this.cartData.order=null,this.backupCartData()},cancelOrder(){return this.changeOrder({status:"canceled"})},changeShippingMethod(t){return this.changeOrder({selected_shipping_method:t})},changeOrder(t={}){return new Promise(function(e,r){this.cartData.order||r(new n("No order")),this.cancelingOrder&&r(),this.cancelingOrder=!0,d.default.ajax({type:"PATCH",url:"/api/projects/"+this.mag.num_id+"/ecommerce/stripe/orders/"+this.cartData.order.id+"/",data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",success:function(a){this.cancelingOrder=!1,e(a)}.bind(this),error:function(a){this.cancelingOrder=!1,r(new n(a.responseText))}})}.bind(this))},setCustomer(t){this.cartData.customer=t,this.backupCartData()},createOrUpdateCustomer(t,e){return new Promise((r,a)=>{d.default.ajax({type:"POST",url:`/api/projects/${t}/ecommerce/stripe/customers/`,data:JSON.stringify({customer_data:e}),contentType:"application/json; charset=utf-8",dataType:"json",success:i=>{r(i)},error:i=>{a(new n(i.responseText))}})})},getCustomer(){return this.cartData.customer},setInvoiceItems(t){this.cartData.invoiceItems=t,this.backupCartData()},unsetInvoiceItems:function(){delete this.cartData.invoiceItems,this.backupCartData()},createInvoiceItems(t,e,r){return new Promise((a,i)=>{d.default.ajax({type:"POST",url:`/api/projects/${t}/ecommerce/stripe/invoice_items/`,data:JSON.stringify({customer_id:e,prices:r}),contentType:"application/json; charset=utf-8",dataType:"json",success:s=>{a(s)},error:s=>{i(new n(s.responseText))}})})},setInvoice(t){this.cartData.invoice=t,this.backupCartData()},unsetInvoice(){delete this.cartData.invoice,this.backupCartData()},createInvoice(t,e){return new Promise((r,a)=>{d.default.ajax({type:"POST",url:`/api/projects/${t}/ecommerce/stripe/invoices/`,data:JSON.stringify({invoiceData:e}),contentType:"application/json; charset=utf-8",dataType:"json",success:i=>{r(i)},error:i=>{i.responseJSON&&i.responseJSON.code==="invoice_no_customer_line_items"?a(new n(i.responseJSON.message,l.nothingToInvoice)):a(new n(i.responseText))}})})},getInvoice(t,e){return new Promise((r,a)=>{d.default.ajax({type:"GET",url:`/api/projects/${t}/ecommerce/stripe/invoices/${e}/`,contentType:"application/json; charset=utf-8",success:i=>{i&&i.data?r(i.data):a(new n("Not valid response, getInvoice"))},error:i=>{a(new n(i.responseText))}})})},deleteDraftInvoice(t,e){return new Promise((r,a)=>{d.default.ajax({type:"DELETE",url:`/api/projects/${t}/ecommerce/stripe/invoices/${e}/`,contentType:"application/json; charset=utf-8",success:i=>{i&&i.data?r(i.data):a(new n("Not valid response"))},error:i=>{a(new n(i.responseText))}})})},voidDraftInvoice(t,e){return new Promise((r,a)=>{d.default.ajax({type:"POST",url:`/api/projects/${t}/ecommerce/stripe/invoices/${e}/void/`,contentType:"application/json; charset=utf-8",success:i=>{i&&i.data?r(i.data):a(new n("Not valid response"))},error:i=>{a(new n(i.responseText))}})})},finalizeInvoice(t,e){return new Promise((r,a)=>{d.default.ajax({type:"POST",url:`/api/projects/${t}/ecommerce/stripe/invoices/${e}/finalize/`,contentType:"application/json; charset=utf-8",success:i=>{i&&i.data?r(i.data):a(new n("Not valid response"))},error:i=>{a(new n(i.responseText))}})})},getPaymentIntent(t,e){return new Promise((r,a)=>{d.default.ajax({type:"GET",url:`/api/projects/${t}/ecommerce/stripe/payment_intents/${e}/`,contentType:"application/json; charset=utf-8",success:i=>{i&&i.data?r(i.data):a(new n("Not valid response"))},error:i=>{a(new n(i.responseText))}})})},updatePaymentIntent(t,e,r){return new Promise((a,i)=>{d.default.ajax({type:"PATCH",url:`/api/projects/${t}/ecommerce/stripe/payment_intents/${e}/`,contentType:"application/json; charset=utf-8",data:JSON.stringify({paymentIntentData:r}),dataType:"json",success:s=>{s&&s.data?a(s.data):i(new n("Not valid response"))},error:s=>{i(new n(s.responseText))}})})},validateCartData:function(t){return!!(t&&typeof t=="object"&&!isNaN(Date.parse(t.changed))&&!isNaN(Date.parse(t.backuped))&&typeof t.uniqSkusCount=="number"&&typeof t.uniqPricesCount=="number"&&typeof t.skus=="object"&&typeof t.prices=="object"&&(typeof t.order=="object"||t.order===null))},getInvalidAddToCartWidgets:function(){let t=this.mag.getAllWidgets().filter(r=>r.type==="addtocart"&&!r.hidden);if(!t||!t.length)return[];let e=this.products?this.products.map(r=>r.id):[];return t.filter(r=>!r.selected_product_id||!e.includes(r.selected_product_id))},restoreBackupCartData(){if(!Modernizr.localstorage)return;let t=localStorage.getItem(this.getStorageKey());if(t){let e=JSON.parse(t);if(!e.provider||e.provider!==this.connectedProvider){this.clearBackup();return}let r=((Date.now()-Date.parse(e.backuped))/1e3/60/60).toFixed(2);this.validateCartData(e)&&r<=24?this.cartData=e:this.clearBackup()}},backupCartData(){Modernizr.localstorage&&(this.cartData.backuped=new Date().toISOString(),localStorage.setItem(this.getStorageKey(),JSON.stringify(this.cartData)))},clearBackup(){Modernizr.localstorage&&localStorage.removeItem(this.getStorageKey())}});C.hasEcommerceWidget=(t,e=[])=>t===p.environment.constructor?!!e.find(r=>r.get("type")==="ecommercecart"):!!e.find(r=>r.type==="ecommercecart");pt=C});export{l as a,n as b,pt as c,R as d,Y as e};
